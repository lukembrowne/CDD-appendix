<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Appendix to Conspecific density dependence in plant communities: a theory-based toolkit for empirical studies - 3&nbsp; Calculating Marginal Effects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./metaregression-comparisons.html" rel="next">
<link href="./calculating-neighborhood.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./calculating-marginal-effects.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Calculating Marginal Effects</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Appendix to Conspecific density dependence in plant communities: a theory-based toolkit for empirical studies</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/lukembrowne/CDD-appendix" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Appendix-to-Conspecific-density-dependence-in-plant-communities--a-theory-based-toolkit-for-empirical-studies.pdf" rel="" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calculating-neighborhood.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Calculating neighborhood densities</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calculating-marginal-effects.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Calculating Marginal Effects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metaregression-comparisons.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Using Meta-regressions to Compare CDD across Species or Sites</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">3.1</span> Overview</a></li>
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link" data-scroll-target="#load-libraries"><span class="header-section-number">3.2</span> Load libraries</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data"><span class="header-section-number">3.3</span> Load data</a></li>
  <li><a href="#handling-data-deficient-species" id="toc-handling-data-deficient-species" class="nav-link" data-scroll-target="#handling-data-deficient-species"><span class="header-section-number">3.4</span> Handling “data deficient” species</a></li>
  <li><a href="#function-for-fitting-models" id="toc-function-for-fitting-models" class="nav-link" data-scroll-target="#function-for-fitting-models"><span class="header-section-number">3.5</span> Function for fitting models</a></li>
  <li><a href="#fit-models" id="toc-fit-models" class="nav-link" data-scroll-target="#fit-models"><span class="header-section-number">3.6</span> Fit models</a></li>
  <li><a href="#summarize-model-fits" id="toc-summarize-model-fits" class="nav-link" data-scroll-target="#summarize-model-fits"><span class="header-section-number">3.7</span> Summarize model fits</a></li>
  <li><a href="#plotting-results" id="toc-plotting-results" class="nav-link" data-scroll-target="#plotting-results"><span class="header-section-number">3.8</span> Plotting results</a></li>
  <li><a href="#ames-absolute-and-relative" id="toc-ames-absolute-and-relative" class="nav-link" data-scroll-target="#ames-absolute-and-relative"><span class="header-section-number">3.9</span> AMEs Absolute and Relative</a>
  <ul class="collapse">
  <li><a href="#settings-for-ames" id="toc-settings-for-ames" class="nav-link" data-scroll-target="#settings-for-ames"><span class="header-section-number">3.9.1</span> Settings for AMEs</a></li>
  <li><a href="#functions-to-calculate-ames-and-rame" id="toc-functions-to-calculate-ames-and-rame" class="nav-link" data-scroll-target="#functions-to-calculate-ames-and-rame"><span class="header-section-number">3.9.2</span> Functions to calculate AMEs and rAME</a></li>
  <li><a href="#calculating-absolute-average-marginal-effect-ames" id="toc-calculating-absolute-average-marginal-effect-ames" class="nav-link" data-scroll-target="#calculating-absolute-average-marginal-effect-ames"><span class="header-section-number">3.9.3</span> Calculating Absolute Average Marginal Effect (AMEs)</a></li>
  <li><a href="#calculating-relative-average-marginal-effect-rames" id="toc-calculating-relative-average-marginal-effect-rames" class="nav-link" data-scroll-target="#calculating-relative-average-marginal-effect-rames"><span class="header-section-number">3.9.4</span> Calculating Relative Average Marginal Effect (rAMEs)</a></li>
  </ul></li>
  <li><a href="#saving-results" id="toc-saving-results" class="nav-link" data-scroll-target="#saving-results"><span class="header-section-number">3.10</span> Saving results</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/lukembrowne/CDD-appendix/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/lukembrowne/CDD-appendix/blob/main/calculating-marginal-effects.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Calculating Marginal Effects</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="overview" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">3.1</span> Overview</h2>
<p>In this section, we examine a <em>subset</em> of the Barro Colorado Island (BCI) 50-ha plot seedling <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.05qfttf85">data</a> to illustrate the impact of conspecific density on mortality probability. We calculate the Average Marginal Effect (<a href="https://marginaleffects.com/">more about marginal effects in general here</a>) as our metric of the strength conspecific density dependence. We then estimate both the absolute Average Marginal Effect (AME) and the relative Average Marginal Effect (rAME). The <strong>AME</strong> represents the average absolute change in mortality probability due to a specified increase in conspecific density. In contrast, the <strong>rAME</strong> is the relative change in mortality probability compared to a baseline value.</p>
<p>The standard approach for modeling plant CDD patterns presumes a linear relationship between performance (e.g., mortality/survival) and conspecific neighborhood density metrics. However, in this section, we use <a href="https://multithreaded.stitchfix.com/blog/2015/07/30/gam/">‘Generalized Additive Models (GAMs)’</a> as it offer flexibility for non-linear relationships between performance and predictors.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note: The code is adapted from the <a href="https://github.com/LisaHuelsmann/latitudinalCNDD/tree/main/code">latitudinalCNDD repository</a> by <a href="https://demographicecology.com/">Lisa Hüelsmann</a>.</p>
</div>
</div>
</section>
<section id="load-libraries" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="load-libraries"><span class="header-section-number">3.2</span> Load libraries</h2>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-1_562db3ada83860a0032830224a3276ec">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra) </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcViz)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat.geom)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="load-data"><span class="header-section-number">3.3</span> Load data</h2>
<p>Our demonstration utilizes a subset of the Barro Colorado Island (BCI) 50-ha forest dynamics plot seedling data, encompassing only 30 species. Seedlings are censused in 1x1 m plots, distributed at 5-m intervals throughout the 50-ha plot. In this example, neighbor densities are calculated using the number of conspecific and heterospecific seedling neighbors within the same 1x1m plot as the focal individual. Please note that this analysis is <em>solely for demonstration purposes</em>; hence, no biological conclusions should be drawn from the results due to the limited data subset used.</p>
<p>The code below assumes the data is in a format where each row is an observation for an individual from a census. For this particular data set, the column descriptions are as follows:</p>
<ul>
<li><p><strong>Id</strong>: unique identifier for each seedling</p></li>
<li><p><strong>plot</strong>: location</p></li>
<li><p><strong>spp</strong>: species</p></li>
<li><p><strong>date:</strong> date of observation</p></li>
<li><p><strong>year:</strong> year of observation</p></li>
<li><p><strong>census</strong>: census number</p></li>
<li><p><strong>status:</strong> status at census, 0 = alive, 1 = dead</p></li>
<li><p><strong>height.last.census</strong>: height.last.census</p></li>
<li><p><strong>con_dens:</strong> number of conspecific neighbors within each seedling plot</p></li>
<li><p><strong>total_dens:</strong> number of total neighbors</p></li>
<li><p><strong>het_dens:</strong> number of heterospecifics neighbors</p></li>
<li><p><strong>time.since.last.census</strong>: time interval between censuses</p></li>
</ul>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-2_7c36cd48b66a002926ea0282541d8540">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_BCI <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./data/BCI_seedling_data_30_spp_2023.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_BCI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "id"                            "q20"                          
 [3] "plot"                          "tag"                          
 [5] "spp"                           "date"                         
 [7] "year"                          "census"                       
 [9] "status"                        "height.last.census"           
[11] "height.last.census.log.scaled" "con_dens"                     
[13] "total_dens"                    "het_dens"                     
[15] "time.since.last.census"       </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure variables are taken as factor</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>census <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>census)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>spp <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>spp)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>plot)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>height<span class="ot">=</span>data_BCI<span class="sc">$</span>height.last.census</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>interval<span class="ot">=</span><span class="fu">as.numeric</span>(data_BCI<span class="sc">$</span>time.since.last.census)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s take a quick look at the data set we’ll be working with:</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-3_03dc2f255012dda7c40e873a0d4327f2">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploring data </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># visualize </span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(data_BCI, <span class="fu">aes</span>(<span class="at">x =</span> con_dens)) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"steelblue2"</span>) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Conspecific density"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Conspecific densities"</span>) <span class="sc">+</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="handling-data-deficient-species" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="handling-data-deficient-species"><span class="header-section-number">3.4</span> Handling “data deficient” species</h2>
<p>We categorize a species as <em>data deficient</em> if it has fewer than four unique conspecific density values. At the end of this section of the code, a data frame named <strong>‘nsp’</strong> will be generated. This data frame will classify each species as either “data deficient” or “not data deficient”.</p>
<p>From our data set 9 species out of 30 were assigned as <em>data deficient</em>. Here, we used the thresholds of 4 unique values of conspecific densities and a minimum range of 1 for conspecific as our thresholds for what constitutes a data deficient species.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-4_82d49d5191cc2127366509d0ed4bf394">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nval <span class="ot">=</span> <span class="dv">4</span>  <span class="do">## this is the number of 'unique' conspecific values </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>minrange <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># minimum range for conspecific density</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>data_BCI <span class="sc">%&gt;%</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(spp) <span class="sc">%&gt;%</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">range_con_dens =</span> <span class="fu">max</span>(con_dens) <span class="sc">-</span> <span class="fu">min</span>(con_dens),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_con_dens =</span> <span class="fu">max</span>(con_dens),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_con_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(con_dens)),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_total_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(total_dens)),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_height =</span> <span class="fu">length</span>(<span class="fu">unique</span>(height.last.census))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if conspecific less than defined nval</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">issue_nval =</span> unique_con_dens <span class="sc">&lt;</span> nval,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># range should at least be equal to minrange</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">issue_range =</span> range_con_dens <span class="sc">&lt;</span> minrange,                 </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">trymodel =</span> <span class="sc">!</span>(issue_nval<span class="sc">|</span>issue_range),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assignment of "data deficient" species</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_deficient =</span> <span class="sc">!</span>trymodel                                          </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> nsp <span class="co"># Store the resulting dataframe in the object 'nsp'</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the top rows of the table 'nsp' in a formatted manner</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>nsp <span class="sc">%&gt;%</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"scale_down"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">spp</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">range_con_dens</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">max_con_dens</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">unique_con_dens</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">unique_total_dens</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">unique_height</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">issue_nval</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">issue_range</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">trymodel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">data_deficient</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ACALDI</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">379</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">AEGICE</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">499</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BEILPE</td>
<td style="text-align: right;">98</td>
<td style="text-align: right;">98</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">894</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">CAPPFR</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">767</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CECRIN</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">177</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">CORDLA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">457</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="function-for-fitting-models" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="function-for-fitting-models"><span class="header-section-number">3.5</span> Function for fitting models</h2>
<p>In the context of the Janzen-Connell Hypothesis, we focus on the differences between CDD and HDD (‘Stabilizing effect’), where conspecific neighbors’ negative effects surpass those from heterospecifics, leading to population stabilization <span class="citation" data-cites="broekman2019signs">(<a href="#ref-broekman2019signs" role="doc-biblioref">Broekman et al. 2019</a>)</span>. This effect is vital for estimating species’ self-limitation.</p>
<p>In this section we illustrate the conspecific density impact, using a model with conspecific density and total density. By using total density in the model instead of heterospecific density, the estimated effect (slope) of conspecific density in our analysis corresponds to the result of subtracting HDD from CDD.</p>
<p>We use here a Generalized Additive Model (GAM) with a complementary log-log (cloglog) link function to model the seedling status (‘alive’ or ‘dead’) as a function of conspecific density <strong>con_dens</strong>, total density <strong>total_dens</strong> and tree height or size of the focal individual (e.g., height or dbh), the latter serving as a covariate.</p>
<p>The cloglog link accounts for differences in observation time Δ𝑡 through an offset term, applicable to datasets where (0=alive and 1=dead)<span class="citation" data-cites="currie2016fitting">(<a href="#ref-currie2016fitting" role="doc-biblioref">Currie 2016</a>)</span>.In other words, to use a cloglog link to account for differences in census interval length, you must be modeling mortality, not survival.</p>
<p>Next, we specify the smooth term in the model formula. The k value determines the complexity of the smooth. If k exceeds the number of unique values in a variable, it’s adjusted to be two less than that number. We also monitor model convergence and any warnings that may arise. With this setup, we establish ‘k=2’ as the minimum value since ‘k=1’ results in a linear relationship. Hence, we defined in the previous section a minimum of 4 unique values for conspecific densities as threshold, as setting a threshold of 3 would enforce linearity in the model.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-5_1a5065f7f89301f8d4be520b5bf5ada7">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to fit a model to the given data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">=</span> <span class="cf">function</span>(data, spinfo, <span class="at">reduced =</span> F) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create new factor with correct factor levels per species </span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>census <span class="ot">=</span> <span class="fu">factor</span>(data<span class="sc">$</span>census)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Determine if there's more than one unique value in 'census' </span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and construct the relevant term for the model formula</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  term_c <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>census)) <span class="sc">&gt;</span> <span class="dv">1</span>, </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"+ s(census, bs = 're')"</span>, <span class="st">""</span>) </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#term_p = "+ s(plot, bs = 're')"</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (reduced) {</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">=</span>  <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"status ~ s(height, k = k1) + </span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(total_dens, k = k2)"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                              , term_c)) <span class="co"># reduced model #,term_p</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">=</span>  <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"status ~ s(height, k = k1) + </span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(total_dens, k = k2) + </span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(con_dens, k = k3)"</span> </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                              , term_c)) <span class="co"># full model #, term_p</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose penalty</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set to default k=10 </span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  k1 <span class="ot">=</span> k2 <span class="ot">=</span> k3 <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k1 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_height) k1 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_height <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k2 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_total_dens) k2 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_total_dens <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k3 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_con_dens) k3 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_con_dens <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1 would force linearity for that term, and we aim to consider </span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># also potential non-linear relationships, so conspecific k is k=2 </span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># minimum.</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a> <span class="co"># Fit the Generalized Additive Model (GAM)</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">try</span>(<span class="fu">gam</span>(form</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                , <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span>cloglog)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>                , <span class="at">offset =</span> <span class="fu">log</span>(interval)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                , <span class="at">data =</span> data</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                , <span class="at">method =</span> <span class="st">"REML"</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  ) , <span class="at">silent =</span> T</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Return the fitted model</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mod)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co"># check model run</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to check the convergence of the model</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>model_convergence <span class="ot">=</span> <span class="cf">function</span>(model) {</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gam not available</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">class</span>(model)<span class="sc">==</span><span class="st">"gam"</span>)) {</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"gam failed"</span>))</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gam not converged</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>model<span class="sc">$</span>converged) {</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"no convergence"</span>))</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore warning "glm.fit: fitted probabilities numerically 0 or 1 </span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># occurred (complete separation)"</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="sc">*</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>      glm0.resids <span class="ot">&lt;-</span> <span class="fu">augment</span>(<span class="at">x =</span> model) <span class="sc">%&gt;%</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">p =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>.fitted)),</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>               <span class="at">warning =</span> p <span class="sc">&gt;</span> <span class="dv">1</span><span class="sc">-</span>eps,</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>               <span class="at">influence =</span> <span class="fu">order</span>(.hat, <span class="at">decreasing =</span> T))</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>      infl_limit <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">nrow</span>(glm0.resids)<span class="sc">/</span><span class="dv">10</span>, <span class="dv">0</span>)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Check if any of the warnings correspond to the 10% most </span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># influential observations. If not, then it is okay.</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>      num <span class="ot">=</span> <span class="fu">any</span>(glm0.resids<span class="sc">$</span>warning <span class="sc">&amp;</span> glm0.resids<span class="sc">$</span>influence <span class="sc">&lt;</span> </span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>                  infl_limit)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there's complete separation</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (num) {</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"complete separation is likely"</span>))</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Check if the Vc component of the model is missing</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(model<span class="sc">$</span>Vc)) {</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"Vc not available"</span>))</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If everything is fine, return the model</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(model)</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fit-models" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="fit-models"><span class="header-section-number">3.6</span> Fit models</h2>
<p>Here we fit the model for all species. <em>data deficient</em> species are treated as one group since there is not sufficient data to be treated independently. In this dataset, we have 9 species that are flagged as ‘data deficient’,</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-6_715cbffe50d640a571c732b7ac91efa9">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the distribution of species marked as 'data deficient' </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (T or F) </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and determine the number of species for which we will try the model </span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We have 9 species that are flagged as 'data deficient'</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">data_deficient =</span> nsp<span class="sc">$</span>data_deficient, <span class="at">trymodel =</span> nsp<span class="sc">$</span>trymodel) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              trymodel
data_deficient FALSE TRUE
         FALSE     0   21
         TRUE      9    0</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert spp to character</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>spp <span class="ot">&lt;-</span> <span class="fu">as.character</span>(data_BCI<span class="sc">$</span>spp)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract species that are flagged as 'data deficient' from the nsp </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># dataframe</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>data_deficient_species <span class="ot">&lt;-</span> nsp<span class="sc">$</span>spp[nsp<span class="sc">$</span>data_deficient <span class="sc">==</span> <span class="cn">TRUE</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace species names with "data_deficient_seedling" for those </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># flagged as 'data_deficient'</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>data_BCI2 <span class="ot">&lt;-</span> data_BCI <span class="sc">%&gt;%</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spp =</span> <span class="fu">ifelse</span>(spp <span class="sc">%in%</span> data_deficient_species, </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"data_deficient_seedling"</span>, spp))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Summarize attributes for each species in the modified dataframe </span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># (including the new #"data_deficient_seedling" group)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>data_BCI2 <span class="sc">%&gt;%</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(spp) <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">range_con_dens =</span> <span class="fu">max</span>(con_dens, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">min</span>(con_dens, </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_con_dens =</span> <span class="fu">max</span>(con_dens, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_con_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(con_dens)),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_total_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(total_dens)),</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_height =</span> <span class="fu">length</span>(<span class="fu">unique</span>(height.last.census))</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># less than nval unique values in consp densities</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">issue_nval =</span> unique_con_dens <span class="sc">&lt;</span> nval, </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># range should at least be equal to minrange</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">issue_range =</span> range_con_dens <span class="sc">&lt;</span> minrange,              </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">trymodel =</span> <span class="sc">!</span>(issue_nval <span class="sc">|</span> issue_range),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># preliminary assignment of data_deficient species</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_deficient =</span> <span class="sc">!</span>trymodel                                      </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> nsp_data_deficient</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="do">####</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit model for each species</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lists to store results of the main and reduced model fits</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co"># List for main model fits</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">=</span> <span class="fu">list</span>()      </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co"># List for reduced model fits (for calculating Pseudo R2)</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>res_red_mod <span class="ot">=</span> <span class="fu">list</span>()  </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through species in the nsp_data_deficient dataframe for which </span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co"># we will try modeling </span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co"># (Here, the group of data_deficient species is treated as a single </span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># species)</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(spp <span class="cf">in</span> nsp_data_deficient<span class="sc">$</span>spp[nsp_data_deficient<span class="sc">$</span>trymodel]) {</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select data for individual species</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  dat_sp <span class="ot">=</span> data_BCI2[data_BCI2<span class="sc">$</span>spp <span class="sc">==</span> spp, ]</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the main and reduced models for the current species</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">model_fit</span>(<span class="at">data =</span> dat_sp, </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>                  <span class="at">spinfo =</span> nsp_data_deficient[nsp_data_deficient<span class="sc">$</span>spp </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                                              <span class="sc">==</span> spp, ])</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>  mod_red <span class="ot">=</span> <span class="fu">model_fit</span>(<span class="at">data =</span> dat_sp, </span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                  <span class="at">spinfo =</span> nsp_data_deficient[nsp_data_deficient<span class="sc">$</span>spp </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                                              <span class="sc">==</span> spp, ], <span class="at">reduced =</span> T)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check the convergence of both models</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">=</span> <span class="fu">model_convergence</span>(<span class="at">model =</span> mod)</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  res_red <span class="ot">=</span> <span class="fu">model_convergence</span>(<span class="at">model =</span> mod_red)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save result</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(res)) {</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    nsp<span class="sc">$</span>data_deficient[nsp<span class="sc">$</span>spp <span class="sc">==</span> spp] <span class="ot">=</span> T  </span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    res_mod[[spp]] <span class="ot">=</span> res</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    res_red_mod[[spp]] <span class="ot">=</span> res_red</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="summarize-model-fits" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="summarize-model-fits"><span class="header-section-number">3.7</span> Summarize model fits</h2>
<p>Regression table via broom::tidy()</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-7_a93f4bc4e5ff63a17f870a805ce01d06">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, broom<span class="sc">::</span>tidy)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">Map</span>(cbind, coefs, <span class="at">sp =</span> <span class="fu">names</span>(coefs))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">do.call</span>(rbind, coefs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Model summary via broom::glance()</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-8_17f622b2f197acd1c50d27792636b104">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For each model result in 'res_mod', extract summary statistics </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (like log-likelihood, AIC, BIC #, etc.) using the 'glance' function</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from the 'broom' package</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># df logLik AIC BIC deviance df.residuals nobs </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, broom<span class="sc">::</span>glance)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">Map</span>(cbind, sums, <span class="at">sp =</span> <span class="fu">names</span>(sums))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">do.call</span>(rbind, sums)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sums)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              df      logLik        AIC        BIC   deviance df.residual  nobs
ACALDI  7.738186   -428.3495   876.0896   924.9334   856.6990   1131.2618  1139
AEGICE  8.763874   -524.7678  1070.5298  1123.3674  1049.5355   1125.2361  1134
BEILPE 17.776666 -11142.3710 22323.8580 22478.1537 22284.7420  19697.2233 19715
CAPPFR 10.233763  -2024.4975  4075.8796  4174.3515  4048.9950  11210.7662 11221
CECRIN  6.221103   -143.4318   301.0402   326.2521   286.8635    252.7789   259
CORDLA  6.840230   -531.0591  1079.4468  1125.3893  1062.1182   1477.1598  1484
           sp
ACALDI ACALDI
AEGICE AEGICE
BEILPE BEILPE
CAPPFR CAPPFR
CECRIN CECRIN
CORDLA CORDLA</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>aucs <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  roc <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">performance_roc</span>(x, <span class="at">new_data =</span> x<span class="sc">$</span>model)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  bayestestR<span class="sc">::</span><span class="fu">area_under_curve</span>(roc<span class="sc">$</span>Spec, roc<span class="sc">$</span>Sens)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>sums<span class="sc">$</span>AUC <span class="ot">=</span> <span class="fu">unlist</span>(aucs)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pseudo R2</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>sums<span class="sc">$</span>pseudoR2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="fu">unlist</span>(<span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x) x<span class="sc">$</span>deviance)) <span class="sc">/</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">unlist</span>(<span class="fu">lapply</span>(res_red_mod, <span class="cf">function</span>(x) </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                         x<span class="sc">$</span>deviance)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="plotting-results" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="plotting-results"><span class="header-section-number">3.8</span> Plotting results</h2>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-9_577f19c4011cb007422d3302789ce89a">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot splines in pdf ----------------------------------------------</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Specify the name of the PDF file where the plots will be saved</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>pdf_file <span class="ot">&lt;-</span> <span class="st">"mortality.pdf"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Open the PDF file for writing</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(pdf_file)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through all the model results stored in 'res_mod'</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res_mod)) {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the vizmod for the current species</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  vizmod <span class="ot">&lt;-</span> <span class="fu">getViz</span>(res_mod[[i]], <span class="at">post =</span> T, <span class="at">unconditional =</span> T)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">plot</span>(vizmod, <span class="at">nsim =</span> <span class="dv">20</span>, <span class="at">allTerms =</span> T) <span class="sc">+</span> </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add confidence interval line/ fit line/ simulation line</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciLine</span>() <span class="sc">+</span> <span class="fu">l_fitLine</span>() <span class="sc">+</span> <span class="fu">l_simLine</span>() <span class="sc">+</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>     <span class="co">#Add confidence interval bar/# Add fitted points</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciBar</span>() <span class="sc">+</span> <span class="fu">l_fitPoints</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_rug</span>() <span class="sc">+</span>                             <span class="co"># Add rug plot</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add title with the name of the current species</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">names</span>(res_mod)[i])       </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the plot to the R console only for the first 2 species</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">2</span>) {</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(pl, <span class="at">pages =</span> <span class="dv">1</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the plot to the PDF</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(pl, <span class="at">pages =</span> <span class="dv">1</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Close the PDF file</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>quartz_off_screen 
                2 </code></pre>
</div>
</div>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-10_65a66d2e79b1697484cfec44f9323138">
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-4.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-5.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-6.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-7.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Hit &lt;Return&gt; to see next plot:</code></pre>
</div>
<div class="cell-output-display">
<p><img src="calculating-marginal-effects_files/figure-html/unnamed-chunk-10-8.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="ames-absolute-and-relative" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="ames-absolute-and-relative"><span class="header-section-number">3.9</span> AMEs Absolute and Relative</h2>
<p>In this section we illustrate the calculation of the average marginal effects, including both the absolute Average Marginal Effect (AME) and the relative Average Marginal Effect (rAME).</p>
<p>Here, <strong>AMEs</strong> are computed by determining the marginal effect (essentially the partial derivative or slope) of a predictor for a unit change change in conspecific density at each observed value, and then averaging these effects. This method yields a single, interpretable measure that offers an averaged estimate of the predictor’s impact. It’s worth noting that the AME, compared to traditional effect sizes, provides a clearer measure of a predictor’s influence by quantifying the average change in the outcome for each unit change in the predictor rather than the raw coefficient (effect size) that may be influenced by the scale of the variable or confounded by interactions with other predictors. In the analyses illustrated here, we are interested in calculating the average marginal effect of conspecific density on mortality.</p>
<p>Furthermore, <strong>rAMEs</strong> enhance the level of interpretability by delivering a normalized measure of these averaged effects. They represent the percentage change in the response variable due to a unit change in the predictor relative to the base mortality, providing an intuitive, relative grasp of the predictor’s influence. This normalization process allows for the comparison of effects across different species, each with its own base level of mortality.</p>
<p>To calculate <strong>AMEs</strong> and <strong>rAMEs</strong> we need the file “res_model” that includes all the models results.</p>
<p>There is also alternative approaches for calculating average marginal effects using <a href="https://marginaleffects.com/articles/slopes.html">‘marginaleffects’ package</a> that we encourage the user to explore.</p>
<section id="settings-for-ames" class="level3" data-number="3.9.1">
<h3 data-number="3.9.1" class="anchored" data-anchor-id="settings-for-ames"><span class="header-section-number">3.9.1</span> Settings for AMEs</h3>
<p>Here we provide three scenarios for calculating <strong>AMEs</strong> or <strong>rAMEs</strong> through the <strong><code>change</code></strong> argument.</p>
<p><strong>Equilibrium</strong>: This scenario computes <strong>AMEs</strong> or <strong>rAMEs</strong> for a unit increase in conspecific density of above observed values, providing insight into the marginal effect of density increase in an existing ecosystem. <strong>Invasion</strong>: This scenario models the effects of introducing species into a new community in which it did not previously occur, transitioning the conspecific density from zero to a specified unit, helping understand the impact of sudden species introductions linking to theoretical considerations from coexistence theory <span class="citation" data-cites="chesson2000mechanisms">(<a href="#ref-chesson2000mechanisms" role="doc-biblioref">Chesson 2000</a>)</span>. <strong>IQR</strong>: This scenario evaluates <strong>AMEs</strong> or <strong>rAMEs</strong> within the middle 50% range of conspecific density, offering a perspective less influenced by extremes, hence providing a more robust understanding of effects within typical density ranges.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-11_a3cb2ba5bfe934b19eb60322b2c508e6">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### chose predictors for local density -setting AMEs</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a vector of predictors with their corresponding names</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">con_dens =</span> <span class="st">"con_dens"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">total_dens =</span> <span class="st">"total_dens"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># change in conspecific density for AME calculations----</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># One more neighbor seedling  </span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># or for adult trees: pi*((dbh_neighbor/1000)/2)^2 *</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#dec_fun(decay_con,dist_neighbor, decay_type) </span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>additive<span class="ot">=</span><span class="dv">1</span>     </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co"># different change settings for con-specific densities</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>interval <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify how the conspecific density should be changed for </span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># different scenarios: </span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 'equilibrium', 'invasion', and 'iqr' (interquartile range)</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>change <span class="ot">=</span> <span class="fu">list</span>(<span class="at">equilibrium =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"paste('+', additive)"</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>              , <span class="at">invasion =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> <span class="st">"c(0, additive)"</span>) </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iqr =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> <span class="st">"c(q1, q3)"</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Set the number of iterations for any subsequent calculations or </span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co"># simulations</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">=</span> <span class="dv">500</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="functions-to-calculate-ames-and-rame" class="level3" data-number="3.9.2">
<h3 data-number="3.9.2" class="anchored" data-anchor-id="functions-to-calculate-ames-and-rame"><span class="header-section-number">3.9.2</span> Functions to calculate AMEs and rAME</h3>
<p>This section will write and define two functions. The setstep fucntion and get_AME fucntion. Get_AME is a function to calculate the Average Marginal Effects for a given term in a model. The function first creates two copies of the data, <strong><code>d0</code></strong> and <strong><code>d1</code></strong>, and adjusts the term of interest based on the <strong><code>change</code></strong> argument (one of the three scenarios described in the previous section). It then calculates the predictions for the two data sets and computes the marginal effects.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-12_4ff91ce96bdf074e1192c1c596fcba5d">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to set the step size for numerical derivatives</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This function determines an appropriate step size using machine's </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># precision/machine epsilon to strike a balance between accuracy and </span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rounding errors.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>setstep <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">=</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x <span class="sc">+</span> (<span class="fu">max</span>(<span class="fu">abs</span>(x), <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(eps)) <span class="sc">-</span> x)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute Average and relative Marginal Effects </span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (AME and rAME) for a given model--------------------</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>get_AME <span class="ot">=</span> <span class="cf">function</span>(mod, data, term</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">change =</span> <span class="cn">NULL</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">at =</span> <span class="cn">NULL</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">offset =</span> <span class="dv">1</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">relative =</span> F</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">iterations =</span> <span class="dv">1000</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">seed =</span> <span class="dv">10</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">samples =</span> F) {</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare two dataframes for different scenarios in marginal </span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># effect computation</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">=</span> d1 <span class="ot">=</span> data</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a> <span class="co"># Adjust the 'term' in the data based on the 'change' parameter</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If change is NULL, adjust the term for numerical derivative </span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># computation</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    d0[[term]] <span class="ot">=</span> d0[[term]] <span class="sc">-</span> <span class="fu">setstep</span>(d0[[term]])</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> d1[[term]] <span class="sc">+</span> <span class="fu">setstep</span>(d1[[term]])</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If change has an additive component, adjust the term accordingly</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>, <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))) {</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> d1[[term]] <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>, <span class="st">""</span>, change))</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If change is explicit with two values, set the term values </span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># directly</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(change) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    d0[[term]] <span class="ot">=</span> <span class="fu">as.numeric</span>(change[<span class="dv">1</span>])</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> <span class="fu">as.numeric</span>(change[<span class="dv">2</span>])</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>   <span class="co"># If 'at' is specified, set predictor values in the data to these </span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fixed values</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (allows the function to calculate the marginal effects at the </span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># specified values)</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(at)) {</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(at))</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>      d0[[i]] <span class="ot">=</span> at[[i]]</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>      d1[[i]] <span class="ot">=</span> at[[i]]</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Create matrices for prediction based on the model</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>  Xp0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> d0, <span class="at">type=</span><span class="st">"lpmatrix"</span>)</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>  Xp1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> d1, <span class="at">type=</span><span class="st">"lpmatrix"</span>)</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a> <span class="co"># Extract model parameters</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>  ilink <span class="ot">&lt;-</span> <span class="fu">family</span>(mod)<span class="sc">$</span>linkinv</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod)</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>  vc <span class="ot">&lt;-</span> mod<span class="sc">$</span>Vc <span class="co"># covariance matrix </span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a> <span class="co"># Compute marginal effects based on the adjusted data</span></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>  pred0   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp0 <span class="sc">%*%</span> beta))<span class="sc">^</span>offset</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>  pred1   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp1 <span class="sc">%*%</span> beta))<span class="sc">^</span>offset</span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>  ME <span class="ot">&lt;-</span> (pred1<span class="sc">-</span>pred0)</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a> <span class="co"># Adjust for numerical derivative if change is NULL</span></span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>    ME <span class="ot">&lt;-</span> ME<span class="sc">/</span>(d1[[term]] <span class="sc">-</span> d0[[term]])</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to relative if requested</span></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (relative <span class="sc">==</span> T) ME <span class="ot">=</span> ME<span class="sc">/</span>pred0</span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># average marginal effect</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>  AME <span class="ot">=</span> <span class="fu">mean</span>(ME)</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate AMEs to compute uncertainty in the estimates</span></span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Compute the variance of the average marginal effect through a </span></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>   <span class="co"># "posterior" simulation.</span></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This involves simulating from a multivariate normal distribution </span></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>   <span class="co"># using the model's  </span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>   <span class="co">#coefficient means and covariance matrix</span></span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>  coefmat <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> iterations</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>                    , <span class="at">mu =</span> beta</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>                    , <span class="at">Sigma =</span> vc)</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each simulated coefficient vector, estimate the Average </span></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marginal Effect (AME).</span></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>  AMEs <span class="ot">=</span> <span class="fu">apply</span>(coefmat, <span class="dv">1</span>, <span class="cf">function</span>(coefrow) {</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate marginal effects based on the simulated coefficient</span></span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>    pred0   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp0 <span class="sc">%*%</span> coefrow))<span class="sc">^</span>offset</span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>    pred1   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp1 <span class="sc">%*%</span> coefrow))<span class="sc">^</span>offset</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a>    ME <span class="ot">&lt;-</span> (pred1<span class="sc">-</span>pred0)</span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if change is NULL, use numerical derivative</span></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a>      ME <span class="ot">&lt;-</span> ME<span class="sc">/</span>(d1[[term]] <span class="sc">-</span> d0[[term]])</span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to relative if requested</span></span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (relative <span class="sc">==</span> T) ME <span class="ot">=</span> ME<span class="sc">/</span>pred0</span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average marginal effect</span></span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a>    AME <span class="ot">=</span> <span class="fu">mean</span>(ME)</span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(AME)</span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine results</span></span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a>   <span class="co"># If the 'samples' flag is FALSE, return the summary results.</span></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, return both the summary and the sample results.</span></span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>samples) {</span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate =</span> AME</span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">std.error =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(AMEs))  </span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate.sim =</span> <span class="fu">mean</span>(AMEs)    </span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>                     , offset</span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">change.value =</span> <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res) </span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>    res_sums <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate =</span> AME</span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">std.error =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(AMEs)) </span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a>                     , offset</span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">change.value =</span> <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    res_samples <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">estimate =</span> AMEs</span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">MLE =</span> AME</span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>                             , offset</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">change.value =</span> <span class="fu">paste</span>(change, </span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">list</span>(res_sums, res_samples)</span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)  </span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="calculating-absolute-average-marginal-effect-ames" class="level3" data-number="3.9.3">
<h3 data-number="3.9.3" class="anchored" data-anchor-id="calculating-absolute-average-marginal-effect-ames"><span class="header-section-number">3.9.3</span> Calculating Absolute Average Marginal Effect (AMEs)</h3>
<p>At the end of this code segment, the <strong>AME</strong> data frame contains average marginal estimates for each predictor, each corresponding to different change scenarios. In essence, AME provides the average effect that a predictor has on the outcome across these scenarios. On the other hand, the <strong>AMEsamples</strong> data frame contains multiple samples of AME for each predictor, each aligned with a specific type of change scenario, which allows for an evaluation of the uncertainty inherent in the AME estimates.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-13_224d478f252aa83fa7c702dec16b0e5d">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Absolute AMEs ---------------------------------------------------</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize empty data frames to store the results</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>AME <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>AMEsamples <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through predictor names that match "con_"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(predictors)[<span class="fu">grepl</span>(<span class="st">"con_"</span>, <span class="fu">names</span>(predictors))]) { </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through different change settings (e.g., equilibrium, invasion,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iqr)</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">names</span>(change)) {</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the AME for each model in res_mod</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x){</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># If the change is based on IQR (interquartile range), calculate the</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 1st and 3rd quartiles</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (j <span class="sc">==</span> <span class="st">"iqr"</span>) {</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        q1 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        q3 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the get_AME function to calculate the AME for the current model</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_AME</span>(x</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>              , <span class="at">data =</span> x<span class="sc">$</span>model</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>              , <span class="at">offset =</span> interval</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>              , <span class="at">term =</span> i</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>              , <span class="at">change =</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> change[[j]][,i]))</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iterations =</span> iter</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>              , <span class="at">samples =</span> T</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AME</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">1</span>]])</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempAME, <span class="at">change =</span> j, <span class="at">sp =</span> <span class="fu">names</span>(tempAME))</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempAME)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    AME <span class="ot">=</span> <span class="fu">rbind</span>(AME, tempAME)</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AME samples</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">2</span>]])</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempSamples, <span class="at">change =</span> j, </span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sp =</span> <span class="fu">names</span>(tempSamples), <span class="at">iter =</span> iter)</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempSamples)</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    AMEsamples <span class="ot">=</span> <span class="fu">rbind</span>(AMEsamples, tempSamples)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(AME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           term    estimate   std.error offset change.value      change     sp
ACALDI con_dens 0.017532523 0.016224521      1          + 1 equilibrium ACALDI
AEGICE con_dens 0.089367793 0.025874547      1          + 1 equilibrium AEGICE
BEILPE con_dens 0.006043419 0.001133492      1          + 1 equilibrium BEILPE
CAPPFR con_dens 0.020945895 0.004433451      1          + 1 equilibrium CAPPFR
CECRIN con_dens 0.028621858 0.026467162      1          + 1 equilibrium CECRIN
CORDLA con_dens 0.013464775 0.030887663      1          + 1 equilibrium CORDLA</code></pre>
</div>
</div>
</section>
<section id="calculating-relative-average-marginal-effect-rames" class="level3" data-number="3.9.4">
<h3 data-number="3.9.4" class="anchored" data-anchor-id="calculating-relative-average-marginal-effect-rames"><span class="header-section-number">3.9.4</span> Calculating Relative Average Marginal Effect (rAMEs)</h3>
<p>At the end of this code segment, the <strong><code>rAME</code></strong> data frame contains the<strong><code>rAME</code></strong> estimates for the predictor and each type of change, and the <strong><code>rAMEsamples</code></strong> data frame contains the <strong><code>rAME</code></strong> samples for each predictor and type of change.</p>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-14_10a6bfe39a7f4a14eea370a4f8536115">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relative rAMEs -----------------------------------------------------------</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize empty data frames to store the results</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>rAME <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>rAMEsamples <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through predictor names that match "con_" </span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(predictors)[<span class="fu">grepl</span>(<span class="st">"con_"</span>, <span class="fu">names</span>(predictors))]) { </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through different change settings </span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (e.g., equilibrium, invasion, iqr)</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">names</span>(change)) {</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the relative AME (rAME) for each model in res_mod</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x){</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># If the change is based on IQR (interquartile range), </span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the 1st and 3rd quartiles</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (j <span class="sc">==</span> <span class="st">"iqr"</span>) {</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        q1 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        q3 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the get_AME function to calculate the rAME for the </span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current model, setting the 'relative' argument to TRUE</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_AME</span>(x</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>              , <span class="at">data =</span> x<span class="sc">$</span>model</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>              , <span class="at">offset =</span> interval</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>              , <span class="at">term =</span> i</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>              , <span class="at">change =</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> change[[j]][, i]))</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iterations =</span> iter</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>              , <span class="at">relative =</span> T</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>              , <span class="at">samples =</span> T</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rAME</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">1</span>]])</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempAME, <span class="at">change =</span> j, <span class="at">sp =</span> <span class="fu">names</span>(tempAME))</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempAME)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    rAME <span class="ot">=</span> <span class="fu">rbind</span>(rAME, tempAME)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rAME samples</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">2</span>]])</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempSamples, <span class="at">change =</span> j, </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sp =</span> <span class="fu">names</span>(tempSamples), <span class="at">iter =</span> iter)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempSamples)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    rAMEsamples <span class="ot">=</span> <span class="fu">rbind</span>(rAMEsamples, tempSamples)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           term   estimate   std.error offset change.value      change     sp
ACALDI con_dens 0.12190548 0.120128285      1          + 1 equilibrium ACALDI
AEGICE con_dens 0.46332386 0.139647517      1          + 1 equilibrium AEGICE
BEILPE con_dens 0.02026319 0.003878029      1          + 1 equilibrium BEILPE
CAPPFR con_dens 0.42934601 0.089120553      1          + 1 equilibrium CAPPFR
CECRIN con_dens 0.04121409 0.041422379      1          + 1 equilibrium CECRIN
CORDLA con_dens 0.10440629 0.243488458      1          + 1 equilibrium CORDLA</code></pre>
</div>
</div>
</section>
</section>
<section id="saving-results" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="saving-results"><span class="header-section-number">3.10</span> Saving results</h2>
<div class="cell" data-hash="calculating-marginal-effects_cache/html/unnamed-chunk-15_3f0a8f680cdab9021ba7951b15efbe6e">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results ---------------------------------------------------</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="at">list =</span> <span class="fu">c</span>(<span class="st">"AME"</span>, <span class="st">"AMEsamples"</span>, <span class="st">"rAME"</span>, <span class="st">"rAMEsamples"</span>, <span class="st">"nsp"</span>, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">"coefs"</span>, <span class="st">"sums"</span>) <span class="co"># "nsp_data_deficient"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>     , <span class="at">file =</span> <span class="fu">paste0</span>( <span class="st">"./data/mortality.Rdata"</span>))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(AME, <span class="st">"./data/AME.csv"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(rAME, <span class="st">"./data/rAME.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-broekman2019signs" class="csl-entry" role="listitem">
Broekman, Maarten JE, Helene C Muller-Landau, Marco D Visser, Eelke Jongejans, SJ Wright, and Hans de Kroon. 2019. <span>“Signs of Stabilisation and Stable Coexistence.”</span> <em>Ecology Letters</em> 22 (11): 1957–75.
</div>
<div id="ref-chesson2000mechanisms" class="csl-entry" role="listitem">
Chesson, Peter. 2000. <span>“Mechanisms of Maintenance of Species Diversity.”</span> <em>Annual Review of Ecology and Systematics</em> 31 (1): 343–66.
</div>
<div id="ref-currie2016fitting" class="csl-entry" role="listitem">
Currie, Iain D. 2016. <span>“On Fitting Generalized Linear and Non-Linear Models of Mortality.”</span> <em>Scandinavian Actuarial Journal</em> 2016 (4): 356–83.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./calculating-neighborhood.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Calculating neighborhood densities</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./metaregression-comparisons.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Using Meta-regressions to Compare CDD across Species or Sites</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> html_document</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">prefer-html:</span><span class="co"> true</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu"># Calculating Marginal Effects</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>In this section, we examine a *subset* of the Barro Colorado Island (BCI) 50-ha plot seedling [data](https://datadryad.org/stash/dataset/doi:10.5061/dryad.05qfttf85) to illustrate the impact of conspecific density on mortality probability. We calculate the Average Marginal Effect ([more about marginal effects in general here](https://marginaleffects.com/)) as our metric of the strength conspecific density dependence. We then estimate both the absolute Average Marginal Effect (AME) and the relative Average Marginal Effect (rAME). The **AME** represents the average absolute change in mortality probability due to a specified increase in conspecific density. In contrast, the **rAME** is the relative change in mortality probability compared to a baseline value.</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>The standard approach for modeling plant CDD patterns presumes a linear relationship between performance (e.g., mortality/survival) and conspecific neighborhood density metrics. However, in this section, we use <span class="co">[</span><span class="ot">'Generalized Additive Models (GAMs)'</span><span class="co">](https://multithreaded.stitchfix.com/blog/2015/07/30/gam/)</span> as it offer flexibility for non-linear relationships between performance and predictors.</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>Note: The code is adapted from the <span class="co">[</span><span class="ot">latitudinalCNDD repository</span><span class="co">](https://github.com/LisaHuelsmann/latitudinalCNDD/tree/main/code)</span> by <span class="co">[</span><span class="ot">Lisa Hüelsmann</span><span class="co">](https://demographicecology.com/)</span>.</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load libraries</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra) </span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) </span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcViz)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat.geom)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load data</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>Our demonstration utilizes a subset of the Barro Colorado Island (BCI) 50-ha forest dynamics plot seedling data, encompassing only 30 species. Seedlings are censused in 1x1 m plots, distributed at 5-m intervals throughout the 50-ha plot. In this example, neighbor densities are calculated using the number of conspecific and heterospecific seedling neighbors within the same 1x1m plot as the focal individual. Please note that this analysis is *solely for demonstration purposes*; hence, no biological conclusions should be drawn from the results due to the limited data subset used.</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>The code below assumes the data is in a format where each row is an observation for an individual from a census. For this particular data set, the column descriptions are as follows:</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Id**: unique identifier for each seedling</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**plot**: location</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**spp**: species</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**date:** date of observation</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**year:** year of observation</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**census**: census number</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**status:** status at census, 0 = alive, 1 = dead</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**height.last.census**: height.last.census</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**con_dens:** number of conspecific neighbors within each seedling plot</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**total_dens:** number of total neighbors</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**het_dens:** number of heterospecifics neighbors</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**time.since.last.census**: time interval between censuses</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>data_BCI <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./data/BCI_seedling_data_30_spp_2023.csv"</span>)</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_BCI)</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure variables are taken as factor</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>census <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>census)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>spp <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>spp)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>plot <span class="ot">&lt;-</span> <span class="fu">factor</span>(data_BCI<span class="sc">$</span>plot)</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>height<span class="ot">=</span>data_BCI<span class="sc">$</span>height.last.census</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>interval<span class="ot">=</span><span class="fu">as.numeric</span>(data_BCI<span class="sc">$</span>time.since.last.census)</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>Let's take a quick look at the data set we'll be working with:</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploring data </span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># visualize </span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(data_BCI, <span class="fu">aes</span>(<span class="at">x =</span> con_dens)) <span class="sc">+</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"steelblue2"</span>) <span class="sc">+</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Conspecific density"</span>, <span class="at">y =</span> <span class="st">"Count"</span>, </span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Conspecific densities"</span>) <span class="sc">+</span> </span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="dv">12</span>)</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Handling "data deficient" species</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>We categorize a species as *data deficient* if it has fewer than four unique conspecific density values. At the end of this section of the code, a data frame named **'nsp'** will be generated. This data frame will classify each species as either "data deficient" or "not data deficient".</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>From our data set 9 species out of 30 were assigned as *data deficient*. Here, we used the thresholds of 4 unique values of conspecific densities and a minimum range of 1 for conspecific as our thresholds for what constitutes a data deficient species.</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>nval <span class="ot">=</span> <span class="dv">4</span>  <span class="do">## this is the number of 'unique' conspecific values </span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>minrange <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># minimum range for conspecific density</span></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>data_BCI <span class="sc">%&gt;%</span> </span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(spp) <span class="sc">%&gt;%</span> </span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>            <span class="at">range_con_dens =</span> <span class="fu">max</span>(con_dens) <span class="sc">-</span> <span class="fu">min</span>(con_dens),</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_con_dens =</span> <span class="fu">max</span>(con_dens),</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_con_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(con_dens)),</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_total_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(total_dens)),</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>            <span class="at">unique_height =</span> <span class="fu">length</span>(<span class="fu">unique</span>(height.last.census))</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if conspecific less than defined nval</span></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">issue_nval =</span> unique_con_dens <span class="sc">&lt;</span> nval,</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># range should at least be equal to minrange</span></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">issue_range =</span> range_con_dens <span class="sc">&lt;</span> minrange,                 </span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">trymodel =</span> <span class="sc">!</span>(issue_nval<span class="sc">|</span>issue_range),</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assignment of "data deficient" species</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_deficient =</span> <span class="sc">!</span>trymodel                                          </span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> nsp <span class="co"># Store the resulting dataframe in the object 'nsp'</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the top rows of the table 'nsp' in a formatted manner</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>nsp <span class="sc">%&gt;%</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"scale_down"</span>))</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a><span class="fu">## Function for fitting models</span></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>In the context of the Janzen-Connell Hypothesis, we focus on the differences between CDD and HDD ('Stabilizing effect'), where conspecific neighbors' negative effects surpass those from heterospecifics, leading to population stabilization <span class="co">[</span><span class="ot">@broekman2019signs</span><span class="co">]</span>. This effect is vital for estimating species' self-limitation.</span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>In this section we illustrate the conspecific density impact, using a model with conspecific density and total density. By using total density in the model instead of heterospecific density, the estimated effect (slope) of conspecific density in our analysis corresponds to the result of subtracting HDD from CDD.</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>We use here a Generalized Additive Model (GAM) with a complementary log-log (cloglog) link function to model the seedling status ('alive' or 'dead') as a function of conspecific density **con_dens**, total density **total_dens** and tree height or size of the focal individual (e.g., height or dbh), the latter serving as a covariate.</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>The cloglog link accounts for differences in observation time Δ𝑡 through an offset term, applicable to datasets where (0=alive and 1=dead)<span class="co">[</span><span class="ot">@currie2016fitting</span><span class="co">]</span>.In other words, to use a cloglog link to account for differences in census interval length, you must be modeling mortality, not survival.</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>Next, we specify the smooth term in the model formula. The k value determines the complexity of the smooth. If k exceeds the number of unique values in a variable, it's adjusted to be two less than that number. We also monitor model convergence and any warnings that may arise. With this setup, we establish 'k=2' as the minimum value since 'k=1' results in a linear relationship. Hence, we defined in the previous section a minimum of 4 unique values for conspecific densities as threshold, as setting a threshold of 3 would enforce linearity in the model.</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to fit a model to the given data</span></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">=</span> <span class="cf">function</span>(data, spinfo, <span class="at">reduced =</span> F) {</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create new factor with correct factor levels per species </span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>census <span class="ot">=</span> <span class="fu">factor</span>(data<span class="sc">$</span>census)</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Determine if there's more than one unique value in 'census' </span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and construct the relevant term for the model formula</span></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>  term_c <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>census)) <span class="sc">&gt;</span> <span class="dv">1</span>, </span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"+ s(census, bs = 're')"</span>, <span class="st">""</span>) </span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">#term_p = "+ s(plot, bs = 're')"</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (reduced) {</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">=</span>  <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"status ~ s(height, k = k1) + </span></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(total_dens, k = k2)"</span></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>                              , term_c)) <span class="co"># reduced model #,term_p</span></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>    form <span class="ot">=</span>  <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">"status ~ s(height, k = k1) + </span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(total_dens, k = k2) + </span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="st">                              s(con_dens, k = k3)"</span> </span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>                              , term_c)) <span class="co"># full model #, term_p</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose penalty</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set to default k=10 </span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>  k1 <span class="ot">=</span> k2 <span class="ot">=</span> k3 <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k1 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_height) k1 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_height <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k2 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_total_dens) k2 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_total_dens <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (k3 <span class="sc">&gt;</span> spinfo<span class="sc">$</span>unique_con_dens) k3 <span class="ot">=</span> spinfo<span class="sc">$</span>unique_con_dens <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># k = 1 would force linearity for that term, and we aim to consider </span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># also potential non-linear relationships, so conspecific k is k=2 </span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># minimum.</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a> <span class="co"># Fit the Generalized Additive Model (GAM)</span></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">try</span>(<span class="fu">gam</span>(form</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>                , <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span>cloglog)</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>                , <span class="at">offset =</span> <span class="fu">log</span>(interval)</span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>                , <span class="at">data =</span> data</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>                , <span class="at">method =</span> <span class="st">"REML"</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>  ) , <span class="at">silent =</span> T</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Return the fitted model</span></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mod)</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a><span class="co"># check model run</span></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to check the convergence of the model</span></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>model_convergence <span class="ot">=</span> <span class="cf">function</span>(model) {</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gam not available</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">class</span>(model)<span class="sc">==</span><span class="st">"gam"</span>)) {</span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"gam failed"</span>))</span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gam not converged</span></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>model<span class="sc">$</span>converged) {</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"no convergence"</span>))</span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore warning "glm.fit: fitted probabilities numerically 0 or 1 </span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>      <span class="co"># occurred (complete separation)"</span></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>      eps <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="sc">*</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>      glm0.resids <span class="ot">&lt;-</span> <span class="fu">augment</span>(<span class="at">x =</span> model) <span class="sc">%&gt;%</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">p =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>.fitted)),</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>               <span class="at">warning =</span> p <span class="sc">&gt;</span> <span class="dv">1</span><span class="sc">-</span>eps,</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>               <span class="at">influence =</span> <span class="fu">order</span>(.hat, <span class="at">decreasing =</span> T))</span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>      infl_limit <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">nrow</span>(glm0.resids)<span class="sc">/</span><span class="dv">10</span>, <span class="dv">0</span>)</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Check if any of the warnings correspond to the 10% most </span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a>      <span class="co"># influential observations. If not, then it is okay.</span></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>      num <span class="ot">=</span> <span class="fu">any</span>(glm0.resids<span class="sc">$</span>warning <span class="sc">&amp;</span> glm0.resids<span class="sc">$</span>influence <span class="sc">&lt;</span> </span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>                  infl_limit)</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there's complete separation</span></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (num) {</span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"complete separation is likely"</span>))</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Check if the Vc component of the model is missing</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(model<span class="sc">$</span>Vc)) {</span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">paste</span>(spp, <span class="st">"Vc not available"</span>))</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If everything is fine, return the model</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(model)</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit models</span></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>Here we fit the model for all species. *data deficient* species are treated as one group since there is not sufficient data to be treated independently. In this dataset, we have 9 species that are flagged as 'data deficient',</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the distribution of species marked as 'data deficient' </span></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a><span class="co"># (T or F) </span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a><span class="co"># and determine the number of species for which we will try the model </span></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="co"># We have 9 species that are flagged as 'data deficient'</span></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">data_deficient =</span> nsp<span class="sc">$</span>data_deficient, <span class="at">trymodel =</span> nsp<span class="sc">$</span>trymodel) </span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert spp to character</span></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>data_BCI<span class="sc">$</span>spp <span class="ot">&lt;-</span> <span class="fu">as.character</span>(data_BCI<span class="sc">$</span>spp)</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract species that are flagged as 'data deficient' from the nsp </span></span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a><span class="co"># dataframe</span></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>data_deficient_species <span class="ot">&lt;-</span> nsp<span class="sc">$</span>spp[nsp<span class="sc">$</span>data_deficient <span class="sc">==</span> <span class="cn">TRUE</span>]</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace species names with "data_deficient_seedling" for those </span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a><span class="co"># flagged as 'data_deficient'</span></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>data_BCI2 <span class="ot">&lt;-</span> data_BCI <span class="sc">%&gt;%</span> </span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spp =</span> <span class="fu">ifelse</span>(spp <span class="sc">%in%</span> data_deficient_species, </span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"data_deficient_seedling"</span>, spp))</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a><span class="co"># # Summarize attributes for each species in the modified dataframe </span></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a><span class="co"># (including the new #"data_deficient_seedling" group)</span></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a>data_BCI2 <span class="sc">%&gt;%</span></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(spp) <span class="sc">%&gt;%</span></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">range_con_dens =</span> <span class="fu">max</span>(con_dens, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">min</span>(con_dens, </span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_con_dens =</span> <span class="fu">max</span>(con_dens, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_con_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(con_dens)),</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_total_dens =</span> <span class="fu">length</span>(<span class="fu">unique</span>(total_dens)),</span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_height =</span> <span class="fu">length</span>(<span class="fu">unique</span>(height.last.census))</span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># less than nval unique values in consp densities</span></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">issue_nval =</span> unique_con_dens <span class="sc">&lt;</span> nval, </span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># range should at least be equal to minrange</span></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">issue_range =</span> range_con_dens <span class="sc">&lt;</span> minrange,              </span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">trymodel =</span> <span class="sc">!</span>(issue_nval <span class="sc">|</span> issue_range),</span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>    <span class="co"># preliminary assignment of data_deficient species</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_deficient =</span> <span class="sc">!</span>trymodel                                      </span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> nsp_data_deficient</span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a><span class="do">####</span></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit model for each species</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lists to store results of the main and reduced model fits</span></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a><span class="co"># List for main model fits</span></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>res_mod <span class="ot">=</span> <span class="fu">list</span>()      </span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a><span class="co"># List for reduced model fits (for calculating Pseudo R2)</span></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>res_red_mod <span class="ot">=</span> <span class="fu">list</span>()  </span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through species in the nsp_data_deficient dataframe for which </span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a><span class="co"># we will try modeling </span></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a><span class="co"># (Here, the group of data_deficient species is treated as a single </span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="co"># species)</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(spp <span class="cf">in</span> nsp_data_deficient<span class="sc">$</span>spp[nsp_data_deficient<span class="sc">$</span>trymodel]) {</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select data for individual species</span></span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>  dat_sp <span class="ot">=</span> data_BCI2[data_BCI2<span class="sc">$</span>spp <span class="sc">==</span> spp, ]</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the main and reduced models for the current species</span></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">=</span> <span class="fu">model_fit</span>(<span class="at">data =</span> dat_sp, </span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>                  <span class="at">spinfo =</span> nsp_data_deficient[nsp_data_deficient<span class="sc">$</span>spp </span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>                                              <span class="sc">==</span> spp, ])</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>  mod_red <span class="ot">=</span> <span class="fu">model_fit</span>(<span class="at">data =</span> dat_sp, </span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>                  <span class="at">spinfo =</span> nsp_data_deficient[nsp_data_deficient<span class="sc">$</span>spp </span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>                                              <span class="sc">==</span> spp, ], <span class="at">reduced =</span> T)</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check the convergence of both models</span></span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">=</span> <span class="fu">model_convergence</span>(<span class="at">model =</span> mod)</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a>  res_red <span class="ot">=</span> <span class="fu">model_convergence</span>(<span class="at">model =</span> mod_red)</span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save result</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(res)) {</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>    nsp<span class="sc">$</span>data_deficient[nsp<span class="sc">$</span>spp <span class="sc">==</span> spp] <span class="ot">=</span> T  </span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a>    res_mod[[spp]] <span class="ot">=</span> res</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>    res_red_mod[[spp]] <span class="ot">=</span> res_red</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summarize model fits</span></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>Regression table via broom::tidy()</span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, broom<span class="sc">::</span>tidy)</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">Map</span>(cbind, coefs, <span class="at">sp =</span> <span class="fu">names</span>(coefs))</span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">do.call</span>(rbind, coefs)</span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>Model summary via broom::glance()</span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="co"># For each model result in 'res_mod', extract summary statistics </span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="co"># (like log-likelihood, AIC, BIC #, etc.) using the 'glance' function</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a><span class="co"># from the 'broom' package</span></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a><span class="co"># df logLik AIC BIC deviance df.residuals nobs </span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, broom<span class="sc">::</span>glance)</span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">Map</span>(cbind, sums, <span class="at">sp =</span> <span class="fu">names</span>(sums))</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>sums <span class="ot">=</span> <span class="fu">do.call</span>(rbind, sums)</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sums)</span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC</span></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>aucs <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x) {</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>  roc <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">performance_roc</span>(x, <span class="at">new_data =</span> x<span class="sc">$</span>model)</span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>  bayestestR<span class="sc">::</span><span class="fu">area_under_curve</span>(roc<span class="sc">$</span>Spec, roc<span class="sc">$</span>Sens)</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>sums<span class="sc">$</span>AUC <span class="ot">=</span> <span class="fu">unlist</span>(aucs)</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a><span class="co"># Pseudo R2</span></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>sums<span class="sc">$</span>pseudoR2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="fu">unlist</span>(<span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x) x<span class="sc">$</span>deviance)) <span class="sc">/</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">unlist</span>(<span class="fu">lapply</span>(res_red_mod, <span class="cf">function</span>(x) </span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>                         x<span class="sc">$</span>deviance)))</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting results</span></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a><span class="co"># plot splines in pdf ----------------------------------------------</span></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a><span class="co"># # Specify the name of the PDF file where the plots will be saved</span></span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>pdf_file <span class="ot">&lt;-</span> <span class="st">"mortality.pdf"</span></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a><span class="co"># Open the PDF file for writing</span></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(pdf_file)</span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through all the model results stored in 'res_mod'</span></span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(res_mod)) {</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the vizmod for the current species</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>  vizmod <span class="ot">&lt;-</span> <span class="fu">getViz</span>(res_mod[[i]], <span class="at">post =</span> T, <span class="at">unconditional =</span> T)</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">plot</span>(vizmod, <span class="at">nsim =</span> <span class="dv">20</span>, <span class="at">allTerms =</span> T) <span class="sc">+</span> </span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add confidence interval line/ fit line/ simulation line</span></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciLine</span>() <span class="sc">+</span> <span class="fu">l_fitLine</span>() <span class="sc">+</span> <span class="fu">l_simLine</span>() <span class="sc">+</span></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a>     <span class="co">#Add confidence interval bar/# Add fitted points</span></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciBar</span>() <span class="sc">+</span> <span class="fu">l_fitPoints</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_rug</span>() <span class="sc">+</span>                             <span class="co"># Add rug plot</span></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add title with the name of the current species</span></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">names</span>(res_mod)[i])       </span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the plot to the R console only for the first 2 species</span></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">2</span>) {</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(pl, <span class="at">pages =</span> <span class="dv">1</span>)</span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the plot to the PDF</span></span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(pl, <span class="at">pages =</span> <span class="dv">1</span>)</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Close the PDF file</span></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{R, echo=FALSE}</span></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a plotting area with 2 rows and 2 columns</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the first two model results in 'res_mod'</span></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the vizmod for the current species</span></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a>  vizmod <span class="ot">&lt;-</span> <span class="fu">getViz</span>(res_mod[[i]], <span class="at">post =</span> T, <span class="at">unconditional =</span> T)</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a>  pl <span class="ot">&lt;-</span> <span class="fu">plot</span>(vizmod, <span class="at">nsim =</span> <span class="dv">20</span>, <span class="at">allTerms =</span> T) <span class="sc">+</span> </span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add confidence interval line/ fit line/ simulation line</span></span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciLine</span>() <span class="sc">+</span> <span class="fu">l_fitLine</span>() <span class="sc">+</span> <span class="fu">l_simLine</span>() <span class="sc">+</span></span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add confidence interval bar/# Add fitted points</span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_ciBar</span>() <span class="sc">+</span> <span class="fu">l_fitPoints</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">l_rug</span>() <span class="sc">+</span>                             <span class="co"># Add rug plot</span></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add title with the name of the current species</span></span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">names</span>(res_mod)[i])       </span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot on the current panel</span></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(pl)</span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset the plotting parameters to default</span></span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="fu">## AMEs Absolute and Relative</span></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>In this section we illustrate the calculation of the average marginal effects, including both the absolute Average Marginal Effect (AME) and the relative Average Marginal Effect (rAME).</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a>Here, **AMEs** are computed by determining the marginal effect (essentially the partial derivative or slope) of a predictor for a unit change change in conspecific density at each observed value, and then averaging these effects. This method yields a single, interpretable measure that offers an averaged estimate of the predictor's impact. It's worth noting that the AME, compared to traditional effect sizes, provides a clearer measure of a predictor's influence by quantifying the average change in the outcome for each unit change in the predictor rather than the raw coefficient (effect size) that may be influenced by the scale of the variable or confounded by interactions with other predictors. In the analyses illustrated here, we are interested in calculating the average marginal effect of conspecific density on mortality.</span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a>Furthermore, **rAMEs** enhance the level of interpretability by delivering a normalized measure of these averaged effects. They represent the percentage change in the response variable due to a unit change in the predictor relative to the base mortality, providing an intuitive, relative grasp of the predictor's influence. This normalization process allows for the comparison of effects across different species, each with its own base level of mortality.</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a>To calculate **AMEs** and **rAMEs** we need the file "res_model" that includes all the models results.</span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a>There is also alternative approaches for calculating average marginal effects using <span class="co">[</span><span class="ot">'marginaleffects' package</span><span class="co">](https://marginaleffects.com/articles/slopes.html)</span> that we encourage the user to explore.</span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a><span class="fu">### Settings for AMEs</span></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a>Here we provide three scenarios for calculating **AMEs** or **rAMEs** through the **`change`** argument.</span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a>**Equilibrium**: This scenario computes **AMEs** or **rAMEs** for a unit increase in conspecific density of above observed values, providing insight into the marginal effect of density increase in an existing ecosystem. **Invasion**: This scenario models the effects of introducing species into a new community in which it did not previously occur, transitioning the conspecific density from zero to a specified unit, helping understand the impact of sudden species introductions linking to theoretical considerations from coexistence theory [@chesson2000mechanisms]. **IQR**: This scenario evaluates **AMEs** or **rAMEs** within the middle 50% range of conspecific density, offering a perspective less influenced by extremes, hence providing a more robust understanding of effects within typical density ranges.</span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a><span class="do">#### chose predictors for local density -setting AMEs</span></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a vector of predictors with their corresponding names</span></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">con_dens =</span> <span class="st">"con_dens"</span>, </span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>                <span class="at">total_dens =</span> <span class="st">"total_dens"</span>)</span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a><span class="co"># change in conspecific density for AME calculations----</span></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a><span class="co"># One more neighbor seedling  </span></span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a><span class="co"># or for adult trees: pi*((dbh_neighbor/1000)/2)^2 *</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#dec_fun(decay_con,dist_neighbor, decay_type) </span></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a>additive<span class="ot">=</span><span class="dv">1</span>     </span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a><span class="co"># different change settings for con-specific densities</span></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>interval <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify how the conspecific density should be changed for </span></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a><span class="co"># different scenarios: </span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a><span class="co"># 'equilibrium', 'invasion', and 'iqr' (interquartile range)</span></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>change <span class="ot">=</span> <span class="fu">list</span>(<span class="at">equilibrium =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> </span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"paste('+', additive)"</span>)</span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a>              , <span class="at">invasion =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> <span class="st">"c(0, additive)"</span>) </span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iqr =</span> <span class="fu">data.frame</span>(<span class="at">con_dens =</span> <span class="st">"c(q1, q3)"</span>)</span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a><span class="do">## Set the number of iterations for any subsequent calculations or </span></span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="co"># simulations</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">=</span> <span class="dv">500</span> </span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a><span class="fu">### Functions to calculate AMEs and rAME</span></span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a>This section will write and define two functions. The setstep fucntion and get_AME fucntion. Get_AME is a function to calculate the Average Marginal Effects for a given term in a model. The function first creates two copies of the data, **`d0`** and **`d1`**, and adjusts the term of interest based on the **`change`** argument (one of the three scenarios described in the previous section). It then calculates the predictions for the two data sets and computes the marginal effects.</span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to set the step size for numerical derivatives</span></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a><span class="co"># This function determines an appropriate step size using machine's </span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a><span class="co"># precision/machine epsilon to strike a balance between accuracy and </span></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a><span class="co"># rounding errors.</span></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a>setstep <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">=</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x <span class="sc">+</span> (<span class="fu">max</span>(<span class="fu">abs</span>(x), <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(eps)) <span class="sc">-</span> x)</span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute Average and relative Marginal Effects </span></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a><span class="co"># (AME and rAME) for a given model--------------------</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a>get_AME <span class="ot">=</span> <span class="cf">function</span>(mod, data, term</span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">change =</span> <span class="cn">NULL</span></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">at =</span> <span class="cn">NULL</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">offset =</span> <span class="dv">1</span></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">relative =</span> F</span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">iterations =</span> <span class="dv">1000</span></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">seed =</span> <span class="dv">10</span></span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a>                   , <span class="at">samples =</span> F) {</span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare two dataframes for different scenarios in marginal </span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a>  <span class="co"># effect computation</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">=</span> d1 <span class="ot">=</span> data</span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a> <span class="co"># Adjust the 'term' in the data based on the 'change' parameter</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If change is NULL, adjust the term for numerical derivative </span></span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>    <span class="co"># computation</span></span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>    d0[[term]] <span class="ot">=</span> d0[[term]] <span class="sc">-</span> <span class="fu">setstep</span>(d0[[term]])</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> d1[[term]] <span class="sc">+</span> <span class="fu">setstep</span>(d1[[term]])</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If change has an additive component, adjust the term accordingly</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>, <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))) {</span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> d1[[term]] <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>, <span class="st">""</span>, change))</span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If change is explicit with two values, set the term values </span></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>  <span class="co"># directly</span></span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(change) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>    d0[[term]] <span class="ot">=</span> <span class="fu">as.numeric</span>(change[<span class="dv">1</span>])</span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>    d1[[term]] <span class="ot">=</span> <span class="fu">as.numeric</span>(change[<span class="dv">2</span>])</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>   <span class="co"># If 'at' is specified, set predictor values in the data to these </span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fixed values</span></span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (allows the function to calculate the marginal effects at the </span></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a>  <span class="co"># specified values)</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(at)) {</span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(at))</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>      d0[[i]] <span class="ot">=</span> at[[i]]</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>      d1[[i]] <span class="ot">=</span> at[[i]]</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Create matrices for prediction based on the model</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>  Xp0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> d0, <span class="at">type=</span><span class="st">"lpmatrix"</span>)</span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>  Xp1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> d1, <span class="at">type=</span><span class="st">"lpmatrix"</span>)</span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a> <span class="co"># Extract model parameters</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a>  ilink <span class="ot">&lt;-</span> <span class="fu">family</span>(mod)<span class="sc">$</span>linkinv</span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod)</span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>  vc <span class="ot">&lt;-</span> mod<span class="sc">$</span>Vc <span class="co"># covariance matrix </span></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a> <span class="co"># Compute marginal effects based on the adjusted data</span></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a>  pred0   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp0 <span class="sc">%*%</span> beta))<span class="sc">^</span>offset</span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>  pred1   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp1 <span class="sc">%*%</span> beta))<span class="sc">^</span>offset</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>  ME <span class="ot">&lt;-</span> (pred1<span class="sc">-</span>pred0)</span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a> <span class="co"># Adjust for numerical derivative if change is NULL</span></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>    ME <span class="ot">&lt;-</span> ME<span class="sc">/</span>(d1[[term]] <span class="sc">-</span> d0[[term]])</span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to relative if requested</span></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (relative <span class="sc">==</span> T) ME <span class="ot">=</span> ME<span class="sc">/</span>pred0</span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>  <span class="co"># average marginal effect</span></span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>  AME <span class="ot">=</span> <span class="fu">mean</span>(ME)</span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate AMEs to compute uncertainty in the estimates</span></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Compute the variance of the average marginal effect through a </span></span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>   <span class="co"># "posterior" simulation.</span></span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>   <span class="co"># This involves simulating from a multivariate normal distribution </span></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>   <span class="co"># using the model's  </span></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a>   <span class="co">#coefficient means and covariance matrix</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>  coefmat <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> iterations</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>                    , <span class="at">mu =</span> beta</span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>                    , <span class="at">Sigma =</span> vc)</span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each simulated coefficient vector, estimate the Average </span></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marginal Effect (AME).</span></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a>  AMEs <span class="ot">=</span> <span class="fu">apply</span>(coefmat, <span class="dv">1</span>, <span class="cf">function</span>(coefrow) {</span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate marginal effects based on the simulated coefficient</span></span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>    pred0   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp0 <span class="sc">%*%</span> coefrow))<span class="sc">^</span>offset</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>    pred1   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">ilink</span>(Xp1 <span class="sc">%*%</span> coefrow))<span class="sc">^</span>offset</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>    ME <span class="ot">&lt;-</span> (pred1<span class="sc">-</span>pred0)</span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if change is NULL, use numerical derivative</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(change)) {</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a>      ME <span class="ot">&lt;-</span> ME<span class="sc">/</span>(d1[[term]] <span class="sc">-</span> d0[[term]])</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to relative if requested</span></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (relative <span class="sc">==</span> T) ME <span class="ot">=</span> ME<span class="sc">/</span>pred0</span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average marginal effect</span></span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a>    AME <span class="ot">=</span> <span class="fu">mean</span>(ME)</span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(AME)</span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine results</span></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a>   <span class="co"># If the 'samples' flag is FALSE, return the summary results.</span></span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, return both the summary and the sample results.</span></span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>samples) {</span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate =</span> AME</span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">std.error =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(AMEs))  </span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate.sim =</span> <span class="fu">mean</span>(AMEs)    </span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>                     , offset</span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">change.value =</span> <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res) </span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a>    res_sums <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">estimate =</span> AME</span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">std.error =</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(AMEs)) </span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a>                     , offset</span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>                     , <span class="at">change.value =</span> <span class="fu">paste</span>(change, <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a>    res_samples <span class="ot">=</span> <span class="fu">data.frame</span>(term</span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">estimate =</span> AMEs</span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">MLE =</span> AME</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a>                             , offset</span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>                             , <span class="at">change.value =</span> <span class="fu">paste</span>(change, </span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">collapse =</span> <span class="st">"_"</span>))</span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">=</span> <span class="fu">list</span>(res_sums, res_samples)</span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)  </span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculating Absolute Average Marginal Effect (AMEs)</span></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a>At the end of this code segment, the **AME** data frame contains average marginal estimates for each predictor, each corresponding to different change scenarios. In essence, AME provides the average effect that a predictor has on the outcome across these scenarios. On the other hand, the **AMEsamples** data frame contains multiple samples of AME for each predictor, each aligned with a specific type of change scenario, which allows for an evaluation of the uncertainty inherent in the AME estimates.</span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a><span class="co"># Absolute AMEs ---------------------------------------------------</span></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize empty data frames to store the results</span></span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a>AME <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a>AMEsamples <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through predictor names that match "con_"</span></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(predictors)[<span class="fu">grepl</span>(<span class="st">"con_"</span>, <span class="fu">names</span>(predictors))]) { </span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through different change settings (e.g., equilibrium, invasion,</span></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iqr)</span></span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">names</span>(change)) {</span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the AME for each model in res_mod</span></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x){</span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a><span class="co"># If the change is based on IQR (interquartile range), calculate the</span></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 1st and 3rd quartiles</span></span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (j <span class="sc">==</span> <span class="st">"iqr"</span>) {</span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a>        q1 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a>        q3 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the get_AME function to calculate the AME for the current model</span></span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_AME</span>(x</span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a>              , <span class="at">data =</span> x<span class="sc">$</span>model</span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a>              , <span class="at">offset =</span> interval</span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a>              , <span class="at">term =</span> i</span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a>              , <span class="at">change =</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> change[[j]][,i]))</span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iterations =</span> iter</span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a>              , <span class="at">samples =</span> T</span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AME</span></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">1</span>]])</span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempAME, <span class="at">change =</span> j, <span class="at">sp =</span> <span class="fu">names</span>(tempAME))</span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempAME)</span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a>    AME <span class="ot">=</span> <span class="fu">rbind</span>(AME, tempAME)</span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AME samples</span></span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">2</span>]])</span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempSamples, <span class="at">change =</span> j, </span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sp =</span> <span class="fu">names</span>(tempSamples), <span class="at">iter =</span> iter)</span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempSamples)</span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a>    AMEsamples <span class="ot">=</span> <span class="fu">rbind</span>(AMEsamples, tempSamples)</span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(AME)</span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculating Relative Average Marginal Effect (rAMEs)</span></span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a>At the end of this code segment, the **`rAME`** data frame contains the**`rAME`** estimates for the predictor and each type of change, and the **`rAMEsamples`** data frame contains the **`rAME`** samples for each predictor and type of change.</span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a><span class="co"># Relative rAMEs -----------------------------------------------------------</span></span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize empty data frames to store the results</span></span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a>rAME <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a>rAMEsamples <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through predictor names that match "con_" </span></span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(predictors)[<span class="fu">grepl</span>(<span class="st">"con_"</span>, <span class="fu">names</span>(predictors))]) { </span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through different change settings </span></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (e.g., equilibrium, invasion, iqr)</span></span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">names</span>(change)) {</span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the relative AME (rAME) for each model in res_mod</span></span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">=</span> <span class="fu">lapply</span>(res_mod, <span class="cf">function</span>(x){</span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb32-763"><a href="#cb32-763" aria-hidden="true" tabindex="-1"></a><span class="co"># If the change is based on IQR (interquartile range), </span></span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the 1st and 3rd quartiles</span></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (j <span class="sc">==</span> <span class="st">"iqr"</span>) {</span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a>        q1 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.25</span>)</span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a>        q3 <span class="ot">=</span> <span class="fu">quantile</span>(x<span class="sc">$</span>model<span class="sc">$</span>con_dens, <span class="at">probs =</span> <span class="fl">0.75</span>)</span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the get_AME function to calculate the rAME for the </span></span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current model, setting the 'relative' argument to TRUE</span></span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get_AME</span>(x</span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a>              , <span class="at">data =</span> x<span class="sc">$</span>model</span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a>              , <span class="at">offset =</span> interval</span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a>              , <span class="at">term =</span> i</span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a>              , <span class="at">change =</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> change[[j]][, i]))</span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a>              , <span class="at">iterations =</span> iter</span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a>              , <span class="at">relative =</span> T</span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a>              , <span class="at">samples =</span> T</span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rAME</span></span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">1</span>]])</span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempAME, <span class="at">change =</span> j, <span class="at">sp =</span> <span class="fu">names</span>(tempAME))</span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>    tempAME <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempAME)</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a>    rAME <span class="ot">=</span> <span class="fu">rbind</span>(rAME, tempAME)</span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rAME samples</span></span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">lapply</span>(temp, <span class="cf">function</span>(x) x[[<span class="dv">2</span>]])</span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">Map</span>(cbind, tempSamples, <span class="at">change =</span> j, </span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sp =</span> <span class="fu">names</span>(tempSamples), <span class="at">iter =</span> iter)</span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a>    tempSamples <span class="ot">=</span> <span class="fu">do.call</span>(rbind, tempSamples)</span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a>    rAMEsamples <span class="ot">=</span> <span class="fu">rbind</span>(rAMEsamples, tempSamples)</span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rAME)</span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a><span class="fu">## Saving results</span></span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results ---------------------------------------------------</span></span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(<span class="at">list =</span> <span class="fu">c</span>(<span class="st">"AME"</span>, <span class="st">"AMEsamples"</span>, <span class="st">"rAME"</span>, <span class="st">"rAMEsamples"</span>, <span class="st">"nsp"</span>, </span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a>              <span class="st">"coefs"</span>, <span class="st">"sums"</span>) <span class="co"># "nsp_data_deficient"</span></span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a>     , <span class="at">file =</span> <span class="fu">paste0</span>( <span class="st">"./data/mortality.Rdata"</span>))</span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(AME, <span class="st">"./data/AME.csv"</span>)</span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(rAME, <span class="st">"./data/rAME.csv"</span>)</span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>